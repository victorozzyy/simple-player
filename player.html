// Event listeners do player
        videoPlayer.addEventListener('timeupdate', () => {
          if (videoPlayer.duration) {
            const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            progress.value = percent;
            timeLabel.textContent = formatTime(videoPlayer.currentTime) + ' / ' + formatTime(videoPlayer.duration);
          }
        });
        
        videoPlayer.addEventListener('ended', () => {
          console.log('✅ Stream completado');
          if (playlist.length > 1) {
            autoplayAttempted = false; // Reset para próximo canal
            switchChannel(1);
          }
        });
        
        videoPlayer.addEventListener('playing', () => {
          hideLoading();
        });
        
        videoPlayer.addEventListener('waiting', () => {
          showLoading('Buffering...');
        });<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Player M3U8</title>
  <script src="js/state-manager.js"></script>
  <!-- HLS.js para reprodução de streams M3U8 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body { 
      font-family: Arial, sans-serif; 
      background: #000; 
      color: #fff;
      overflow: hidden;
    }
    
    /* Container do vídeo */
    #videoContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    
    #videoPlayer {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    #controls {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      background: rgba(0,0,0,0.9);
      padding: 15px 25px;
      border-radius: 12px;
      transition: opacity 0.3s ease;
      z-index: 100;
    }
    
    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    button {
      font-size: 16px;
      padding: 10px 20px;
      background: #222;
      color: white;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #333;
      border-color: #0f0;
    }
    
    button:focus {
      outline: none;
      border-color: #0f0;
      background: #333;
    }
    
    #btnBack {
      background: #c00;
    }
    
    #btnBack:hover {
      background: #e00;
      border-color: #f00;
    }
    
    
    
    #progress {
      flex: 1;
      height: 8px;
      cursor: pointer;
    }
    
    #time {
      font-size: 14px;
      color: white;
      font-variant-numeric: tabular-nums;
      background: rgba(0,0,0,0.8);
      padding: 8px 16px;
      border-radius: 6px;
      min-width: 140px;
      text-align: center;
    }
    
    #channelTitle {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 20px;
      transition: opacity 0.3s ease;
      z-index: 100;
    }
    
    #channelTitle.hidden {
      opacity: 0;
    }
    
    #loadingMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      color: #fff;
      padding: 40px 60px;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      z-index: 200;
      border: 2px solid #0f0;
    }
    
    #loadingMessage.hidden {
      display: none;
    }

    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(139, 0, 0, 0.95);
      color: #fff;
      padding: 40px 60px;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      z-index: 200;
      border: 2px solid #f00;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Container do vídeo -->
  <div id="videoContainer">
    <video id="videoPlayer" controls></video>
  </div>

  <div id="loadingMessage">
    <div>⏳ Carregando canal...</div>
    <div id="loadingDetails" style="margin-top: 10px; font-size: 14px; color: #999;"></div>
  </div>

  <div id="errorMessage">
    <div id="errorText">❌ Erro ao carregar stream</div>
  </div>

  <!-- Botão de play inicial para permitir autoplay -->
  <div id="playButton" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #00c851 0%, #007E33 100%);
    color: #fff;
    padding: 50px 100px;
    border-radius: 25px;
    font-size: 24px;
    text-align: center;
    z-index: 300;
    cursor: pointer;
    border: 4px solid #0f0;
    display: none;
    user-select: none;
    transition: all 0.3s ease;
    box-shadow: 0 10px 40px rgba(0, 255, 0, 0.4);
    animation: pulse 2s infinite;
  " 
     tabindex="0"
     onmouseover="this.style.transform='translate(-50%, -50%) scale(1.05)'; this.style.boxShadow='0 15px 50px rgba(0, 255, 0, 0.6)'" 
     onmouseout="this.style.transform='translate(-50%, -50%) scale(1)'; this.style.boxShadow='0 10px 40px rgba(0, 255, 0, 0.4)'">
    <div style="font-size: 64px; margin-bottom: 15px; animation: bounce 1s infinite;">▶️</div>
    <div style="font-weight: bold; font-size: 28px;">Clique para Reproduzir</div>
    <div style="font-size: 16px; margin-top: 15px; opacity: 0.9;">
      <span id="channelNamePreview" style="color: #ffeb3b; font-weight: bold;"></span>
    </div>
    <div style="font-size: 13px; margin-top: 10px; opacity: 0.7;">
      Pressione Enter ou Espaço
    </div>
  </div>

  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    #playButton:focus {
      outline: none;
      border-color: #ffeb3b;
      box-shadow: 0 15px 50px rgba(255, 235, 59, 0.6);
    }
    
    #playButton:active {
      transform: translate(-50%, -50%) scale(0.95) !important;
    }
  </style>

  <div id="channelTitle">📺 Carregando...</div>

  <div id="controls">
    <button id="btnBack">🔙 Voltar</button>
    <button id="prev">⏮ Anterior</button>
    <button id="rew">⏪ -10s</button>
    <button id="playpause" autofocus>▶️ Play</button>
    <button id="fwd">⏩ +10s</button>
    <button id="next">⏭ Próximo</button>
    <button id="reload">🔄 Recarregar</button>
  </div>

  <div id="progressContainer">
    <span id="time">00:00 / 00:00</span>
    <input type="range" id="progress" value="0" min="0" max="100">
  </div>

  <script>
    console.log('╔═══════════════════════════════════════╗');
    console.log('🚀 PLAYER WEB INICIADO');
    console.log('╚═══════════════════════════════════════╝');

    // Elementos
    const videoPlayer = document.getElementById('videoPlayer');
    const controls = document.getElementById('controls');
    const progressContainer = document.getElementById('progressContainer');
    const channelTitle = document.getElementById('channelTitle');
    const progress = document.getElementById('progress');
    const timeLabel = document.getElementById('time');
    const buttons = Array.from(controls.querySelectorAll('button'));
    const loadingMessage = document.getElementById('loadingMessage');
    const loadingDetails = document.getElementById('loadingDetails');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const playButton = document.getElementById('playButton');
    const channelNamePreview = document.getElementById('channelNamePreview');

    // Estado
    let hls = null;
    let isPlaying = false;
    let hideTimer = null;
    let playlist = [];
    let currentIndex = 0;
    let currentUrl = '';
    let userInteracted = false;
    let pendingPlayUrl = null;
    let pendingPlayName = null;
    let autoplayAttempted = false;

    // ==========================================
    // PARÂMETROS DA URL
    // ==========================================
    function getParams() {
      const params = new URLSearchParams(window.location.search);
      const url = params.get('url');
      const name = params.get('name') || 'Canal';
      const index = parseInt(params.get('index') || '0');
      
      console.log('📋 Parâmetros da URL:');
      console.log('  URL:', url);
      console.log('  Nome:', name);
      console.log('  Índice:', index);
      
      return { url, name, index };
    }

    const params = getParams();

    // ==========================================
    // CARREGAR ESTADO DO STATEMANAGER
    // ==========================================
    function loadSavedState() {
      console.log('📦 Carregando estado salvo...');
      
      if (typeof StateManager === 'undefined') {
        console.warn('⚠️ StateManager não disponível');
        return false;
      }

      try {
        const savedState = StateManager.loadPlayerState();
        
        if (savedState) {
          console.log('✅ Estado encontrado:', {
            canal: savedState.name,
            index: savedState.channelIndex,
            playlistSize: savedState.playlist?.length || 0
          });
          
          if (savedState.playlist && Array.isArray(savedState.playlist)) {
            playlist = savedState.playlist;
            currentIndex = savedState.channelIndex || params.index || 0;
            
            console.log('✅ Playlist restaurada:', playlist.length, 'canais');
            console.log('✅ Índice atual:', currentIndex);
            return true;
          }
        }
      } catch (error) {
        console.error('❌ Erro ao carregar estado:', error);
      }
      
      return false;
    }

    loadSavedState();

    // ==========================================
    // VOLTAR PARA LISTA DE CANAIS
    // ==========================================
    function backToChannels() {
        console.log('🔙 VOLTANDO PARA LISTA DE CANAIS');
        
        stopPlayer();
        
        if (typeof StateManager !== 'undefined') {
            StateManager.markReturnFromPlayer();
            const returnUrl = StateManager.getReturnUrl();
            
            setTimeout(() => {
                window.location.href = returnUrl;
            }, 100);
        } else {
            sessionStorage.setItem('returningFromPlayer', 'true');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 100);
        }
    }

    document.getElementById('btnBack').addEventListener('click', backToChannels);

    // ==========================================
    // FORMATAR TEMPO
    // ==========================================
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // ==========================================
    // CONTROLES DE UI
    // ==========================================
    function showControls() {
      controls.classList.remove('hidden');
      progressContainer.classList.remove('hidden');
      channelTitle.classList.remove('hidden');
      
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => {
        controls.classList.add('hidden');
        progressContainer.classList.add('hidden');
        channelTitle.classList.add('hidden');
      }, 5000);
    }

    function showLoading(message) {
      loadingMessage.classList.remove('hidden');
      errorMessage.style.display = 'none';
      loadingDetails.textContent = message || '';
    }

    function hideLoading() {
      loadingMessage.classList.add('hidden');
    }

    function showError(message) {
      errorText.textContent = message;
      errorMessage.style.display = 'block';
      loadingMessage.classList.add('hidden');
      
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    // ==========================================
    // INICIALIZAR PLAYER COM AUTOPLAY
    // ==========================================
    function initPlayer(url, name) {
      console.log('╔═══════════════════════════════════════╗');
      console.log('🎬 INICIALIZANDO PLAYER');
      console.log('URL:', url);
      console.log('Nome:', name);
      console.log('User Interacted:', userInteracted);
      console.log('╚═══════════════════════════════════════╝');

      if (!url || url.trim() === '') {
        console.error('❌ URL inválida');
        showError('❌ URL inválida');
        return;
      }

      channelTitle.textContent = '📺 ' + name;
      
      // Sempre preparar o vídeo, mas só tocar após interação se necessário
      showLoading('Conectando ao stream...');

      try {
        stopPlayer();
        currentUrl = url;
        
        // Guardar para possível replay
        pendingPlayUrl = url;
        pendingPlayName = name;
        
        // Detectar tipo de stream
        const isM3U8 = url.toLowerCase().includes('.m3u8') || url.toLowerCase().includes('m3u8');
        const isMP4 = url.toLowerCase().endsWith('.mp4');
        
        if (isM3U8 && Hls.isSupported()) {
          // Usar HLS.js para streams M3U8
          console.log('📡 Usando HLS.js');
          hls = new Hls({
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 90
          });
          
          hls.loadSource(url);
          hls.attachMedia(videoPlayer);
          
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log('✅ Manifest carregado');
            tryAutoplay();
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('❌ Erro HLS:', data.type, data.details);
            if (data.fatal) {
              switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  showError('❌ Erro de rede');
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  showError('❌ Erro de mídia');
                  hls.recoverMediaError();
                  break;
                default:
                  showError('❌ Erro fatal no stream');
                  stopPlayer();
                  break;
              }
            }
          });
          
        } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl') || isMP4) {
          // Suporte nativo (Safari) ou MP4
          console.log('📡 Usando reprodução nativa');
          videoPlayer.src = url;
          
          videoPlayer.addEventListener('loadedmetadata', () => {
            console.log('✅ Metadados carregados');
            tryAutoplay();
          }, { once: true });
          
          videoPlayer.addEventListener('error', (e) => {
            console.error('❌ Erro no vídeo:', e);
            showError('❌ Erro ao carregar stream');
          });
          
        } else {
          showError('❌ Formato não suportado neste navegador');
        }
        
      } catch (e) {
        console.error('❌ Exceção:', e.message);
        showError('❌ Erro ao inicializar: ' + e.message);
      }
    }

    // ==========================================
    // TENTAR AUTOPLAY
    // ==========================================
    function tryAutoplay() {
      if (autoplayAttempted) {
        console.log('⚠️ Autoplay já foi tentado');
        return;
      }
      
      autoplayAttempted = true;
      console.log('🎬 Tentando autoplay...');
      
      videoPlayer.play().then(() => {
        console.log('✅ Autoplay bem-sucedido!');
        isPlaying = true;
        document.getElementById('playpause').textContent = '⏸ Pause';
        hideLoading();
        showControls();
        userInteracted = true;
      }).catch(error => {
        console.warn('⚠️ Autoplay bloqueado:', error.name);
        
        if (error.name === 'NotAllowedError') {
          // Mostrar botão de play
          console.log('📺 Mostrando botão de play');
          channelNamePreview.textContent = pendingPlayName;
          playButton.style.display = 'block';
          hideLoading();
        } else {
          showError('❌ Erro ao iniciar reprodução');
        }
      });
    }

    // ==========================================
    // INICIAR REPRODUÇÃO MANUAL
    // ==========================================
    function startPlayback() {
      console.log('▶️ Iniciando reprodução manual');
      autoplayAttempted = false; // Reset para tentar novamente
      
      videoPlayer.play().then(() => {
        console.log('✅ Reprodução iniciada!');
        isPlaying = true;
        document.getElementById('playpause').textContent = '⏸ Pause';
        playButton.style.display = 'none';
        showControls();
        userInteracted = true;
      }).catch(error => {
        console.error('❌ Erro ao reproduzir:', error);
        showError('❌ Erro ao iniciar: ' + error.message);
      });
    }

    // ==========================================
    // PARAR PLAYER
    // ==========================================
    function stopPlayer() {
      try {
        if (hls) {
          hls.destroy();
          hls = null;
        }
        videoPlayer.pause();
        videoPlayer.src = '';
        isPlaying = false;
        currentUrl = '';
      } catch (e) {
        console.warn('⚠️ Erro ao parar:', e);
      }
    }

    // ==========================================
    // CONTROLES DE REPRODUÇÃO
    // ==========================================
    function togglePlayPause() {
      try {
        if (videoPlayer.paused) {
          videoPlayer.play();
          isPlaying = true;
          document.getElementById('playpause').textContent = '⏸ Pause';
        } else {
          videoPlayer.pause();
          isPlaying = false;
          document.getElementById('playpause').textContent = '▶️ Play';
        }
        showControls();
      } catch (e) {
        console.error('❌ Erro:', e);
      }
    }

    function seek(seconds) {
      try {
        videoPlayer.currentTime = Math.max(0, Math.min(videoPlayer.duration, videoPlayer.currentTime + seconds));
        showControls();
      } catch (e) {
        console.warn('⚠️ Seek não disponível');
      }
    }

    function reload() {
      console.log('🔄 Recarregando...');
      initPlayer(currentUrl, params.name);
    }

    // ==========================================
    // TROCA DE CANAIS
    // ==========================================
    function switchChannel(offset) {
      if (playlist.length === 0) {
        console.warn('⚠️ Playlist vazia');
        return;
      }

      currentIndex = (currentIndex + offset + playlist.length) % playlist.length;
      const nextChannel = playlist[currentIndex];

      if (!nextChannel || !nextChannel.url) {
        console.warn('❌ Canal inválido');
        return;
      }

      console.log(`🔄 Canal ${currentIndex + 1}/${playlist.length}: ${nextChannel.name}`);

      if (typeof StateManager !== 'undefined') {
        StateManager.updateChannelIndex(currentIndex);
      }

      params.url = nextChannel.url;
      params.name = nextChannel.name;
      params.index = currentIndex;

      autoplayAttempted = false; // Reset para novo canal
      initPlayer(nextChannel.url, nextChannel.name);
    }

    // ==========================================
    // EVENTOS DOS BOTÕES
    // ==========================================
    document.getElementById('playpause').addEventListener('click', togglePlayPause);
    document.getElementById('rew').addEventListener('click', () => seek(-10));
    document.getElementById('fwd').addEventListener('click', () => seek(10));
    document.getElementById('reload').addEventListener('click', reload);
    document.getElementById('prev').addEventListener('click', () => switchChannel(-1));
    document.getElementById('next').addEventListener('click', () => switchChannel(1));

    progress.addEventListener('input', () => {
      try {
        if (videoPlayer.duration) {
          videoPlayer.currentTime = (progress.value / 100) * videoPlayer.duration;
        }
      } catch (e) {}
    });

    // ==========================================
    // TECLADO
    // ==========================================
    document.addEventListener('keydown', (e) => {
      // BACK
      if (e.key === 'Backspace' || e.key === 'Escape') {
        e.preventDefault();
        backToChannels();
        return;
      }

      showControls();

      const focused = document.activeElement;
      const idx = buttons.indexOf(focused);

      switch(e.key) {
        case 'ArrowRight':
          if (idx >= 0) {
            e.preventDefault();
            buttons[(idx + 1) % buttons.length].focus();
          }
          break;

        case 'ArrowLeft':
          if (idx >= 0) {
            e.preventDefault();
            buttons[(idx - 1 + buttons.length) % buttons.length].focus();
          }
          break;

        case 'Enter':
          if (idx >= 0) {
            e.preventDefault();
            focused.click();
          }
          break;

        case 'ArrowUp':
          e.preventDefault();
          switchChannel(-1);
          break;

        case 'ArrowDown':
          e.preventDefault();
          switchChannel(1);
          break;

        case ' ':
          e.preventDefault();
          togglePlayPause();
          break;
      }
    });

    // Mostrar controles ao mover mouse
    videoPlayer.addEventListener('mousemove', showControls);
    document.addEventListener('mousemove', showControls);

    // ==========================================
    // BOTÃO DE PLAY INICIAL
    // ==========================================
    playButton.addEventListener('click', () => {
      console.log('✅ Usuário clicou no botão de play');
      userInteracted = true;
      startPlayback();
    });

    // Permitir Enter/Espaço no botão de play
    playButton.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        userInteracted = true;
        startPlayback();
      }
    });

    // ==========================================
    // INICIALIZAÇÃO
    // ==========================================
    window.addEventListener('load', () => {
      console.log('✅ PÁGINA CARREGADA');

      if (!params.url) {
        console.error('❌ URL não fornecida');
        showError('❌ URL não fornecida');
        setTimeout(backToChannels, 3000);
        return;
      }

      setTimeout(() => {
        initPlayer(params.url, params.name);
        
        // Se botão de play aparecer, dar foco nele
        const checkButton = setInterval(() => {
          if (playButton.style.display === 'block') {
            playButton.focus();
            clearInterval(checkButton);
          }
        }, 100);
        
        // Limpar interval após 3 segundos
        setTimeout(() => clearInterval(checkButton), 3000);
      }, 500);
    });

    window.addEventListener('beforeunload', stopPlayer);

    console.log('✅ PLAYER CONFIGURADO');
  </script>
</body>
</html>
