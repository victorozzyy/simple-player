<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Filtro M3U8 â€” VersÃ£o Otimizada (Streaming)</title>
<style>
  :root {
    --bg: #000;
    --card: #2b2b2b;
    --muted: #b0b0b0;
    --primary: #10a37f;
    --primary-hover: #0e8f6f;
    --accent: #fff;
    --radius: 10px;
    --shadow: 0 8px 24px rgba(15,23,42,0.1);
    --mono: 'Segoe UI', Roboto, Arial, Helvetica, sans-serif;
  }
  html,body {height:100%;margin:0;background:var(--bg);font-family:var(--mono);color:var(--accent);}
  .wrap {width:920px;margin:48px auto;}
  .card {background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;box-sizing:border-box;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .title{display:flex;gap:14px;align-items:center;}
  .logo{width:42px;height:42px;border-radius:8px;background:linear-gradient(135deg,#0ea37f,#0b8b6d);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 4px 12px rgba(14,139,111,0.18);}
  h1{font-size:18px;margin:0;}
  p.lead{margin:0;font-size:13px;color:var(--muted);}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:18px;}
  .panel{background:#1a1a1a;border-radius:8px;padding:14px;border:1px solid #333;}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
  input[type="file"]{display:block;}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#111;color:#fff;font-size:14px;margin-bottom:8px;box-sizing:border-box;}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
  button{background:var(--primary);color:white;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 6px 14px rgba(16,163,127,0.12);}
  button:hover{background:var(--primary-hover);}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #444;box-shadow:none;}
  textarea#output{width:100%;height:420px;padding:14px;border-radius:8px;border:1px solid #333;background:#111;color:#0f0;font-family:monospace;font-size:13px;resize:vertical;box-sizing:border-box;margin-top:12px;}
  .category-list{margin-top:12px;padding:10px;border-radius:8px;border:1px dashed #444;background:#111;max-height:150px;overflow:auto;font-size:13px;color:var(--muted);}
  .category-list label{display:block;margin-bottom:4px;cursor:pointer;}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin-top:12px;}
  .progress{flex:1;height:10px;background:#333;border-radius:999px;overflow:hidden;border:1px solid #444;}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#10a37f,#7ad9bb);width:0%;}
  footer{margin-top:14px;display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:13px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="title">
        <div class="logo">M3</div>
        <div>
          <h1>Filtro M3U8 â€” VersÃ£o Otimizada</h1>
          <p class="lead">Filtra em streaming â€” baixo uso de memÃ³ria</p>
        </div>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="panel">
          <label>1ï¸âƒ£ Selecione o arquivo (.m3u ou .m3u8)</label>
          <input id="fileInput" type="file" accept=".m3u,.m3u8">
          <label style="margin-top:10px">2ï¸âƒ£ Palavras-chave (separadas por vÃ­rgula)</label>
          <input id="keywords" type="text" placeholder="Ex: filmes, esportes, infantil">

          <div class="actions">
            <button id="includeBtn">ğŸ¯ Filtrar (Incluir)</button>
            <button id="excludeBtn">âŒ Filtrar (Excluir)</button>
            <button id="showCatsBtn" class="ghost">ğŸ“š Mostrar Categorias</button>
            <button id="excludeCatsBtn" class="ghost">ğŸ—‚ï¸ Excluir Categorias Selecionadas</button>
            <button id="downloadBtn" class="ghost">â¬‡ï¸ Baixar</button>
            <button id="copyBtn" class="ghost">ğŸ“‹ Copiar</button>
          </div>

          <div class="progress-wrap">
            <div class="progress"><i id="progressBar"></i></div>
            <div style="width:78px;text-align:right;font-size:13px;color:var(--muted)" id="progressPct">0%</div>
          </div>

          <div style="margin-top:8px;font-size:13px;color:var(--muted);">
            Processados: <span id="processedBytes">0</span> bytes | Canais: <span id="foundCount">0</span>
          </div>
        </div>

        <h3 style="margin:12px 0 8px 0;">Resultado</h3>
        <textarea id="output" readonly placeholder="O resultado aparecerÃ¡ aqui..."></textarea>
        <div id="categoriesBox" class="category-list" style="display:none;"></div>
      </div>

      <aside>
        <div style="background:#111;padding:12px;border-radius:8px;border:1px solid #333;text-align:center;">
          <div style="font-size:14px;color:var(--muted);">Tempo estimado</div>
          <div style="font-size:18px;font-weight:700;margin-top:6px" id="timeEst">â€”</div>
        </div>
      </aside>
    </div>

    <footer>
      <div>Processamento local â€” baixo uso de memÃ³ria</div>
      <div id="statusMsg">Pronto</div>
    </footer>
  </div>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const includeBtn = document.getElementById("includeBtn");
const excludeBtn = document.getElementById("excludeBtn");
const excludeCatsBtn = document.getElementById("excludeCatsBtn");
const showCatsBtn = document.getElementById("showCatsBtn");
const downloadBtn = document.getElementById("downloadBtn");
const copyBtn = document.getElementById("copyBtn");
const outputEl = document.getElementById("output");
const progressBar = document.getElementById("progressBar");
const progressPct = document.getElementById("progressPct");
const processedBytesEl = document.getElementById("processedBytes");
const foundCountEl = document.getElementById("foundCount");
const categoriesBox = document.getElementById("categoriesBox");
const statusMsg = document.getElementById("statusMsg");
const timeEstEl = document.getElementById("timeEst");

let lastResults = [];
let lastCategories = new Set();

includeBtn.addEventListener("click", () => startFilter("include"));
excludeBtn.addEventListener("click", () => startFilter("exclude"));
excludeCatsBtn.addEventListener("click", handleCategoryExclusion);
showCatsBtn.addEventListener("click", handleShowCategories);
downloadBtn.addEventListener("click", handleDownload);
copyBtn.addEventListener("click", handleCopy);

function resetUI() {
  outputEl.value = "";
  progressBar.style.width = "0%";
  progressPct.textContent = "0%";
  processedBytesEl.textContent = "0";
  foundCountEl.textContent = "0";
  categoriesBox.innerHTML = "";
  categoriesBox.style.display = "none";
  statusMsg.textContent = "Pronto";
  timeEstEl.textContent = "â€”";
}

async function startFilter(mode) {
  resetUI();
  const file = fileInput.files[0];
  if (!file) return alert("Selecione um arquivo primeiro.");
  await processFileStreaming(file, mode);
}

async function processFileStreaming(file, mode) {
  const startTime = performance.now();
  const CHUNK_SIZE = 512 * 1024; // 512 KB
  const total = file.size;
  const reader = new FileReader();
  const decoder = new TextDecoder("utf-8");
  let offset = 0;
  let leftover = "";
  let prev = null;
  const results = [];
  const unique = new Set();
  const cats = new Set();
  let processed = 0, count = 0;

  const keywordsRaw = document.getElementById("keywords").value.trim();
  const keywords = keywordsRaw ? keywordsRaw.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean) : [];

  async function readChunk() {
    if (offset >= total) return finalize();
    const slice = file.slice(offset, offset + CHUNK_SIZE);
    reader.readAsArrayBuffer(slice);
  }

  reader.onload = async e => {
    const text = decoder.decode(e.target.result);
    processed += e.target.result.byteLength;
    const combined = leftover + text;
    const lines = combined.split(/\r?\n/);
    leftover = lines.pop();

    for (let l of lines) {
      if (/group-title\s*=\s*"/i.test(l)) {
        const m = /group-title\s*=\s*"([^"]+)"/i.exec(l);
        if (m && m[1]) cats.add(m[1]);
      }
      if (/^#EXTINF/i.test(l)) { prev = l; continue; }
      if (prev && l && !l.startsWith("#")) {
        const keep = filterDecision(prev, keywords, mode);
        if (keep && !unique.has(l)) {
          unique.add(l);
          results.push(prev, l);
          count++;
        }
        prev = null;
      }
    }

    const pct = Math.floor((processed / total) * 100);
    progressBar.style.width = pct + "%";
    progressPct.textContent = pct + "%";
    processedBytesEl.textContent = processed.toLocaleString();
    foundCountEl.textContent = count.toLocaleString();

    offset += CHUNK_SIZE;
    await new Promise(r => setTimeout(r, 0)); // libera a UI
    readChunk();
  };

  reader.onerror = () => alert("Erro ao ler o arquivo.");
  readChunk();

  function finalize() {
    if (leftover) {
      const lines = leftover.split(/\r?\n/);
      for (let l of lines) {
        if (/group-title\s*=\s*"/i.test(l)) {
          const m = /group-title\s*=\s*"([^"]+)"/i.exec(l);
          if (m && m[1]) cats.add(m[1]);
        }
      }
    }
    timeEstEl.textContent = ((performance.now() - startTime)/1000).toFixed(1) + "s";
    progressBar.style.width = "100%";
    progressPct.textContent = "100%";
    outputEl.value = results.join("\n") || "Nenhum resultado encontrado.";
    statusMsg.textContent = `ConcluÃ­do â€” ${count} canais mantidos.`;
    lastResults = results;
    lastCategories = cats;
    if (cats.size > 0) showCategories(cats);
  }
}

function filterDecision(line, keywords, mode) {
  if (!keywords.length) return true;
  const lower = line.toLowerCase();
  const has = keywords.some(k => lower.includes(k));
  return mode === "include" ? has : !has;
}

function safeBase64(str) {
  try { return btoa(unescape(encodeURIComponent(str))); }
  catch { return Math.random().toString(36).substring(2,10); }
}

function showCategories(cats) {
  categoriesBox.innerHTML = "<strong>Categorias detectadas:</strong><br><br>";
  cats.forEach(cat=>{
    const id = "cat_" + safeBase64(cat);
    categoriesBox.innerHTML += `<label><input type="checkbox" value="${cat}" id="${id}"> ${cat}</label>`;
  });
  categoriesBox.style.display = "block";
}

async function handleShowCategories() {
  const file = fileInput.files[0];
  if (!file) return alert("Selecione um arquivo primeiro.");
  const decoder = new TextDecoder("utf-8");
  const reader = file.stream().getReader();
  const cats = new Set();
  let leftover = "";
  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const text = decoder.decode(value, {stream:true});
    const combined = leftover + text;
    const lines = combined.split(/\r?\n/);
    leftover = lines.pop();
    for (const l of lines) {
      const m = /group-title\s*=\s*"([^"]+)"/i.exec(l);
      if (m && m[1]) cats.add(m[1]);
    }
  }
  lastCategories = cats;
  showCategories(cats);
  statusMsg.textContent = `${cats.size} categorias detectadas.`;
}

function handleCategoryExclusion() {
  if (!lastResults.length) return alert("Primeiro gere uma lista filtrada.");
  const checked = [...categoriesBox.querySelectorAll("input[type=checkbox]:checked")].map(el=>el.value);
  if (!checked.length) return alert("Selecione ao menos uma categoria.");
  const filtered = [];
  let prev = null;
  for (const line of lastResults) {
    if (/^#EXTINF/i.test(line)) { prev = line; continue; }
    if (prev && !checked.some(cat => prev.includes(`group-title=\"${cat}\"`))) {
      filtered.push(prev, line);
    }
    prev = null;
  }
  outputEl.value = filtered.join("\n") || "Todos os canais dessas categorias foram removidos.";
  statusMsg.textContent = `Categorias removidas: ${checked.join(", ")}`;
}

function handleDownload() {
  if (!outputEl.value) return alert("Nada para baixar.");
  const blob = new Blob([outputEl.value], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "playlist_filtrada.m3u";
  a.click();
}

async function handleCopy() {
  if (!outputEl.value) return alert("Nada para copiar.");
  await navigator.clipboard.writeText(outputEl.value);
  alert("âœ… Copiado!");
}
</script>
</body>
</html>
